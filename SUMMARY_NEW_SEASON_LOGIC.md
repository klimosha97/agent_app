# üìã –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π: –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —Å–µ–∑–æ–Ω–∞–º–∏

## üéØ –ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è

**–ë—ã–ª–æ:** –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–æ–≤ —Å–æ–∑–¥–∞–≤–∞–ª–æ –Ω–æ–≤—ã–π slice (1-30 ‚Üí 1-31 ‚Üí 1-32 = 3 —Å–ª–∞–π—Å–∞)  
**–°—Ç–∞–ª–æ:** –û–¥–∏–Ω slice –Ω–∞ —Å–µ–∑–æ–Ω, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –§–∞–π–ª: `backend/app/services/data_loader.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `load_file()`:

```python
# –ë—ã–ª–æ:
def load_file(file_path, tournament_id, slice_type, period_type, period_value):
    slice_id = self._upsert_slice(...)
    # –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–ª –Ω–æ–≤—ã–π slice –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ period_value

# –°—Ç–∞–ª–æ:
def load_file(file_path, tournament_id, slice_type, period_type, 
              period_value=None, force_new_season=False):
    # –î–ª—è SEASON: –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π slice (–µ—Å–ª–∏ –Ω–µ force_new_season)
    # –î–ª—è ROUND: —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π slice
```

#### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:

1. **`_get_tournament_season()`** - –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω –∏–∑ –ë–î
2. **`_check_new_season_needed()`** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–µ–Ω –ª–∏ –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω
3. **`_upsert_slice()`** –æ–±–Ω–æ–≤–ª—ë–Ω:
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Tuple[int, bool]` (slice_id, is_new)
   - –î–ª—è SEASON –∏—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç
   - –î–ª—è ROUND –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π

### 2. –§–∞–π–ª: `backend/app/api/upload.py`

#### –ù–æ–≤—ã–µ endpoints:

1. **`POST /api/upload-season-stats`** - –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Å–µ–∑–æ–Ω
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `file, tournament_id, slice_type, season, force_new_season`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `slice_id, is_new_slice, players_loaded, stats_loaded`

2. **`GET /api/check-new-season/{tournament_id}`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `slice_type, new_season`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `needs_new_season, current_season, new_season, message`

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞

```python
# 1Ô∏è‚É£ –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—Ç—É—Ä—ã 1-30)
loader.load_file(
    file_path='mfl.xlsx',
    tournament_id=0,
    slice_type='TOTAL',
    period_type='SEASON',
    period_value='2025'
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: slice_id=1, is_new_slice=True

# 2Ô∏è‚É£ –ü—Ä–æ—à—ë–ª 31 —Ç—É—Ä, –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª
loader.load_file(
    file_path='mfl.xlsx',
    tournament_id=0,
    slice_type='TOTAL',
    period_type='SEASON',
    period_value='2025'  # –¢–û–¢ –ñ–ï —Å–µ–∑–æ–Ω
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: slice_id=1, is_new_slice=False ‚¨ÖÔ∏è –û–ë–ù–û–í–õ–Å–ù!
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞

```python
# 3Ô∏è‚É£ –ù–∞—á–∞–ª—Å—è —Å–µ–∑–æ–Ω 2026, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π slice
loader.load_file(
    file_path='mfl.xlsx',
    tournament_id=0,
    slice_type='TOTAL',
    period_type='SEASON',
    period_value='2026',  # –ù–û–í–´–ô —Å–µ–∑–æ–Ω
    force_new_season=True       # ‚¨ÖÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π!
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: slice_id=2, is_new_slice=True ‚¨ÖÔ∏è –ù–û–í–´–ô SLICE!
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `stat_slices` - –ø—Ä–∏–º–µ—Ä—ã:

| slice_id | tournament_id | slice_type | period_type | period_value | uploaded_at |
|----------|---------------|------------|-------------|--------------|-------------|
| 1        | 0             | TOTAL      | SEASON      | 2025    | 2024-12-15  |
| 2        | 0             | PER90      | SEASON      | 2025    | 2024-12-15  |
| 3        | 0             | TOTAL      | ROUND       | 31           | 2024-12-15  |
| 4        | 0             | TOTAL      | SEASON      | 2026    | 2025-09-01  |

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- `slice_id=1` - —Å—É–º–º–∞—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–∑–æ–Ω 2025 (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
- `slice_id=2` - —Å—Ä–µ–¥–Ω—è—è –∑–∞ 90 –º–∏–Ω—É—Ç –¥–ª—è —Å–µ–∑–æ–Ω–∞ 2025 (–æ—Ç–¥–µ–ª—å–Ω—ã–π slice!)
- `slice_id=3` - –¥–∞–Ω–Ω—ã–µ –∑–∞ 31-–π —Ç—É—Ä (–æ—Ç–¥–µ–ª—å–Ω—ã–π slice –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—É—Ä–∞)
- `slice_id=4` - –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω 2026 (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ force_new_season=True)

---

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### ‚úÖ –ë—ã–ª–æ (–ø—Ä–æ–±–ª–µ–º—ã):

```
–ó–∞–≥—Ä—É–∑–∫–∞ 1: mfl.xlsx (1-30) ‚Üí slice_id=1, period_value='1-30'
–ó–∞–≥—Ä—É–∑–∫–∞ 2: mfl.xlsx (1-31) ‚Üí slice_id=2, period_value='1-31'  ‚ùå
–ó–∞–≥—Ä—É–∑–∫–∞ 3: mfl.xlsx (1-32) ‚Üí slice_id=3, period_value='1-32'  ‚ùå

–ü—Ä–æ–±–ª–µ–º–∞: 30 —Å–ª–∞–π—Å–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞! üò±
```

### ‚úÖ –°—Ç–∞–ª–æ (—Ä–µ—à–µ–Ω–∏–µ):

```
–ó–∞–≥—Ä—É–∑–∫–∞ 1: mfl.xlsx (1-30) ‚Üí slice_id=1, season='2025'
–ó–∞–≥—Ä—É–∑–∫–∞ 2: mfl.xlsx (1-31) ‚Üí slice_id=1 (–æ–±–Ω–æ–≤–ª—ë–Ω) ‚úÖ
–ó–∞–≥—Ä—É–∑–∫–∞ 3: mfl.xlsx (1-32) ‚Üí slice_id=1 (–æ–±–Ω–æ–≤–ª—ë–Ω) ‚úÖ
...
–ù–æ–≤—ã–π —Å–µ–∑–æ–Ω: mfl.xlsx      ‚Üí slice_id=2, season='2026' ‚úÖ

–†–µ–∑—É–ª—å—Ç–∞—Ç: 1 —Å–ª–∞–π—Å –Ω–∞ —Å–µ–∑–æ–Ω! ‚ú®
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

### 1. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–µ–∑–æ–Ω–µ

```python
# –ï—Å–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω –±–µ–∑ force_new_season=True:
result = loader.load_file(
    period_value='2026',  # –ù–æ–≤—ã–π —Å–µ–∑–æ–Ω
    force_new_season=False      # –ù–æ –Ω–µ —É–∫–∞–∑–∞–ª–∏!
)

# –í –ª–æ–≥–∞—Ö:
# ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω: 2026
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ force_new_season=True –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ª–∞–π—Å–∞
# –ò–ª–∏ —Ç–µ–∫—É—â–∏–π —Å–ª–∞–π—Å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω
```

### 2. API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```javascript
// –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–∞:
const check = await fetch('/api/check-new-season/0?new_season=2026');

if (check.needs_new_season) {
  const confirmed = confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω?');
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å force_new_season = confirmed
}
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏

### –î–ª—è `period_type='SEASON'`:

```python
# 1Ô∏è‚É£ –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π slice –ø–æ –∫–ª—é—á—É:
#    (tournament_id, slice_type, period_type, period_value)

# 2Ô∏è‚É£ –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∏ force_new_season=False:
#    - –û–±–Ω–æ–≤–ª—è–µ—Ç uploaded_at
#    - –£–î–ê–õ–Ø–ï–¢ —Å—Ç–∞—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
#    - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ù–û–í–£–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

# 3Ô∏è‚É£ –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ force_new_season=True:
#    - –°–æ–∑–¥–∞—ë—Ç –ù–û–í–´–ô slice
#    - –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```

### –î–ª—è `period_type='ROUND'`:

```python
# –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç –ù–û–í–´–ô slice –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—É—Ä–∞
# (–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
```

---

## üéì –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î, –Ω—É–∂–Ω–æ:

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `season`** –≤ `tournaments`:

```sql
ALTER TABLE tournaments 
ADD COLUMN IF NOT EXISTS season VARCHAR(20) DEFAULT '2025';
```

2. **–û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–ª–∞–π—Å—ã** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

```sql
-- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å period_value –¥–ª—è SEASON —Å–ª–∞–π—Å–æ–≤
UPDATE stat_slices 
SET period_value = '2025'
WHERE period_type = 'SEASON' 
  AND period_value LIKE '1-%';  -- –ë—ã–ª–æ '1-30' ‚Üí —Å—Ç–∞–Ω–µ—Ç '2025'
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã:

1. **`db/NEW_SEASON_LOGIC.md`** - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
2. **`EXAMPLES_NEW_SEASON.md`** - –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
3. **`SUMMARY_NEW_SEASON_LOGIC.md`** - –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## ‚ú® –ò—Ç–æ–≥–æ

**–ì–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
> –°–ª–∞–π—Å = –°–ï–ó–û–ù, –∞ –Ω–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–æ–≤. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö = –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≥–æ –∂–µ slice.

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
- –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Ä–∞–∑ - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤—è—Ç—Å—è
- –ü—Ä–∏ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –°–ü–†–û–°–ò–¢: "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω?"
- –ò—Å—Ç–æ—Ä–∏—è —Å–µ–∑–æ–Ω–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

**–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**
- –ß–∏—Å—Ç–∞—è –ë–î –±–µ–∑ –¥—É–±–ª–µ–π
- –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ (1 slice = 1 season)
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

**–ì–æ—Ç–æ–≤–æ! üéâ**

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–≥–∏—á–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ!



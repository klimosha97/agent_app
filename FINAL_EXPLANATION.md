# 🎯 ФИНАЛЬНОЕ ОБЪЯСНЕНИЕ: Как работает БД (для чайников)

## 📚 Содержание

1. [Структура БД простыми словами](#структура-бд-простыми-словами)
2. [Как загружается файл МФЛ](#как-загружается-файл-мфл)
3. [Как обновляются данные](#как-обновляются-данные)
4. [Как сравнивать с средними по позиции](#как-сравнивать-с-средними-по-позиции)
5. [Как связаны все таблицы](#как-связаны-все-таблицы)
6. [Схема всех процессов](#схема-всех-процессов)

---

## 1️⃣ Структура БД простыми словами

Представь, что БД - это **библиотека**:

```
📚 БИБЛИОТЕКА "FOOTBALL STATS"

📁 Справочники (постоянные):
   📖 tournaments - список турниров (МФЛ, ЮФЛ-1, ЮФЛ-2, ЮФЛ-3)
   📖 positions - список позиций (Ф Ц, АП Л, П Ц, З Ц...)
   📖 metrics_catalog - список метрик (goals, xg, shots...)

📁 Данные игроков:
   📄 players - карточки игроков (имя, команда, позиция, турнир)
   
📁 Статистика:
   📊 stat_slices - "папки" со статистикой (МФЛ 2025, МФЛ 2026...)
   📈 player_statistics - сама статистика (голы, передачи, удары...)
```

### Как это связано:

```
tournaments (МФЛ)
    ↓
players (Помалюк, Спартак, Форвард)
    ↓
    ├── stat_slices (МФЛ 2025 TOTAL)
    │       ↓
    │   player_statistics (21 гол, 87 ударов...)
    │
    └── stat_slices (МФЛ 2025 PER90)
            ↓
        player_statistics (0.85 голов/матч...)
```

---

## 2️⃣ Как загружается файл МФЛ

### Шаг за шагом:

#### 📂 Шаг 1: Открываешь файл `mfl.xlsx`

```
Excel файл содержит:
┌─────────────────────────────────────────────────┐
│ Игрок             │ Команда  │ Позиция │ Голы   │
├─────────────────────────────────────────────────┤
│ Помалюк Александр │ Спартак  │ Ф Ц    │ 21     │
│ Иванов Пётр       │ ЦСКА     │ АП Л   │ 15     │
│ ...               │ ...      │ ...    │ ...    │
└─────────────────────────────────────────────────┘
896 игроков × 52 метрики = 46,592 значений
```

#### 🔄 Шаг 2: Система создаёт "папку" (slice)

```python
# Создаёт запись в stat_slices:
{
    'slice_id': 1,
    'tournament_id': 0,        # МФЛ
    'slice_type': 'TOTAL',     # Суммарная статистика
    'period_type': 'SEASON',   # За сезон
    'period_value': '2025' # Сезон 2025
}
```

**Это как создать папку на диске:**
```
📁 МФЛ/
  └─ 📊 2024-2025_TOTAL/  ⬅️ Это slice_id=1
```

#### 👤 Шаг 3: Для каждого игрока создаётся карточка

```python
# Для Помалюка:
{
    'player_id': 1,
    'full_name': 'Александр Помалюк',
    'birth_year': 2005,
    'team_name': 'Спартак',
    'position_id': 1,          # Ф Ц (форвард центральный)
    'tournament_id': 0         # МФЛ
}
```

**Уникальность игрока:** (имя + год_рождения + команда + турнир)

Если Помалюк перейдёт в ЦСКА → создастся **НОВАЯ** карточка (player_id=897)!

#### 📈 Шаг 4: Для каждой метрики создаётся запись

```python
# Для Помалюка в slice_id=1:
[
    {'player_id': 1, 'slice_id': 1, 'metric_code': 'goals', 'metric_value': 21.0},
    {'player_id': 1, 'slice_id': 1, 'metric_code': 'xg', 'metric_value': 14.27},
    {'player_id': 1, 'slice_id': 1, 'metric_code': 'shots', 'metric_value': 87.0},
    {'player_id': 1, 'slice_id': 1, 'metric_code': 'assists', 'metric_value': 5.0},
    # ... ещё 48 метрик
]
```

#### ✅ Итого после загрузки:

```
📚 БД после загрузки mfl.xlsx:

📊 stat_slices:
   slice_id=1: МФЛ 2025 TOTAL

📄 players:
   896 игроков (Помалюк, Иванов, Петров...)

📈 player_statistics:
   46,592 записей (896 игроков × 52 метрики)
```

---

## 3️⃣ Как обновляются данные

### Сценарий A: Обновление статистики текущего сезона

**Ситуация:** Прошёл 31-й тур, загружаешь обновлённый `mfl.xlsx`

```
┌─────────────────────────────────────────────────────────────┐
│                    ЧТО ПРОИСХОДИТ В БД                      │
└─────────────────────────────────────────────────────────────┘

1️⃣ Система ищет: есть ли slice для (МФЛ, TOTAL, SEASON, 2025)?
   
   SELECT slice_id FROM stat_slices
   WHERE tournament_id = 0
     AND slice_type = 'TOTAL'
     AND period_type = 'SEASON'
     AND period_value = '2025';
   
   Результат: slice_id = 1 ✅ НАЙДЕН!

2️⃣ Обновляет дату загрузки:
   
   UPDATE stat_slices
   SET uploaded_at = NOW()
   WHERE slice_id = 1;

3️⃣ УДАЛЯЕТ старую статистику:
   
   DELETE FROM player_statistics 
   WHERE slice_id = 1;
   
   Удалено: 46,592 записей ❌

4️⃣ Загружает НОВУЮ статистику:
   
   INSERT INTO player_statistics (...)
   VALUES 
      (1, 1, 'goals', 23.0),  -- Было 21 → стало 23 ✅
      (1, 1, 'xg', 15.85),    -- Было 14.27 → стало 15.85 ✅
      ...
   
   Вставлено: 46,592 записей (новые данные) ✅

5️⃣ Игроки обновляются/добавляются:
   
   INSERT INTO players (...) 
   VALUES (...)
   ON CONFLICT (name, birth_year, team, tournament)
   DO UPDATE SET position = ..., updated_at = NOW();
```

### Результат:

```
📚 БД после обновления:

📊 stat_slices:
   slice_id=1: МФЛ 2025 TOTAL (uploaded_at обновлён) ✅

📄 players:
   896 игроков (те же карточки, обновлённые данные) ✅

📈 player_statistics:
   46,592 записей (НОВЫЕ значения) ✅
   
   Помалюк:
   - Голы: 21 → 23 ✅
   - xG: 14.27 → 15.85 ✅
```

---

### Сценарий B: Начало нового сезона

**Ситуация:** Начался сезон 2026, загружаешь новый `mfl.xlsx`

```
┌─────────────────────────────────────────────────────────────┐
│            ЧТО ПРОИСХОДИТ ПРИ НОВОМ СЕЗОНЕ                  │
└─────────────────────────────────────────────────────────────┘

1️⃣ Система ищет: есть ли slice для (МФЛ, TOTAL, SEASON, 2026)?
   
   SELECT slice_id FROM stat_slices
   WHERE period_value = '2026';
   
   Результат: НЕТ ❌

2️⃣ Система спрашивает пользователя:
   
   ⚠️ "Обнаружен новый сезон: 2026"
   "Создать новый slice? (force_new_season=True)"
   
   Пользователь: ДА ✅

3️⃣ Создаёт НОВЫЙ slice:
   
   INSERT INTO stat_slices (...)
   VALUES (0, 'TOTAL', 'SEASON', '2026');
   
   Результат: slice_id = 2 ✨ НОВЫЙ!

4️⃣ Загружает статистику в НОВЫЙ slice:
   
   INSERT INTO player_statistics (...)
   VALUES 
      (1, 2, 'goals', 5.0),   -- slice_id = 2 (новый сезон)
      (1, 2, 'xg', 3.82),
      ...

5️⃣ Игроки: те же или новые (если состав изменился)
```

### Результат:

```
📚 БД после нового сезона:

📊 stat_slices:
   slice_id=1: МФЛ 2025 TOTAL ⬅️ СОХРАНИЛСЯ!
   slice_id=2: МФЛ 2026 TOTAL ⬅️ НОВЫЙ!

📄 players:
   896 игроков (старые карточки)
   + новые игроки (если есть)

📈 player_statistics:
   Помалюк в сезоне 2025 (slice_id=1):
   - Голы: 23 ✅ (итоги прошлого сезона)
   
   Помалюк в сезоне 2026 (slice_id=2):
   - Голы: 5 ✅ (начало нового сезона)
```

---

## 4️⃣ Как сравнивать с средними по позиции

### Пример: "Помалюк - хороший форвард?"

#### Шаг 1: Находим средние по всем форвардам

```sql
-- Средняя статистика всех форвардов МФЛ в сезоне 2025 (PER90)
SELECT 
    AVG(ps.metric_value) as avg_goals_per90
FROM player_statistics ps
JOIN players p ON ps.player_id = p.player_id
JOIN positions pos ON p.position_id = pos.position_id
JOIN stat_slices ss ON ps.slice_id = ss.slice_id
WHERE 
    ss.tournament_id = 0           -- МФЛ
    AND ss.slice_type = 'PER90'    -- За 90 минут
    AND ss.period_value = '2025'
    AND pos.group_code = 'ATT'     -- Форварды (ATT = attack)
    AND ps.metric_code = 'goals';

-- Результат: 0.35 голов/матч (среднее по всем форвардам)
```

#### Шаг 2: Сравниваем Помалюка с средним

```sql
SELECT 
    p.full_name,
    ps.metric_value as player_goals_per90,
    0.35 as avg_goals_per90,
    (ps.metric_value - 0.35) as diff,
    CASE 
        WHEN ps.metric_value > 0.35 THEN '✅ Выше среднего'
        ELSE '❌ Ниже среднего'
    END as result
FROM player_statistics ps
JOIN players p ON ps.player_id = p.player_id
JOIN stat_slices ss ON ps.slice_id = ss.slice_id
WHERE 
    p.full_name = 'Александр Помалюк'
    AND ss.slice_type = 'PER90'
    AND ss.period_value = '2025'
    AND ps.metric_code = 'goals';
```

**Результат:**

| full_name | player_goals_per90 | avg_goals_per90 | diff | result |
|-----------|-------------------|-----------------|------|--------|
| Помалюк   | 0.85              | 0.35            | +0.50 | ✅ Выше среднего |

**Вывод:** Помалюк забивает **в 2.4 раза больше** среднего форварда! 🌟

---

### Как это работает визуально:

```
🎯 СРАВНЕНИЕ ПОМАЛЮКА С СРЕДНИМИ ПО ФОРВАРДАМ

Все форварды МФЛ:
│
├─ Игрок 1: 0.2 голов/матч
├─ Игрок 2: 0.3 голов/матч
├─ ...
├─ Игрок 50: 0.4 голов/матч
│
└─ СРЕДНЕЕ: 0.35 голов/матч  ⬅️ Считаем AVG()

Помалюк: 0.85 голов/матч

Сравнение:
0.85 - 0.35 = +0.50  ✅ ВЫШЕ СРЕДНЕГО!

Визуально:
Среднее:  ▓▓▓▓▓▓▓ 0.35
Помалюк:  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ 0.85  🌟🌟🌟
```

---

## 5️⃣ Как связаны все таблицы

### Полная схема связей:

```
┌──────────────────┐
│   tournaments    │  Справочник турниров
│  id=0: МФЛ       │
│  id=1: ЮФЛ-1     │
└────────┬─────────┘
         │
         │ tournament_id
         ↓
┌────────────────────────┐
│       players          │  Игроки турнира
│  player_id = 1         │
│  full_name = Помалюк   │
│  team_name = Спартак   │
│  tournament_id = 0     │◄────────┐
│  position_id = 1       │         │
└────────┬───────────────┘         │
         │                         │
         │ position_id             │
         ↓                         │
┌──────────────────┐               │
│    positions     │  Позиции      │
│  position_id = 1 │               │
│  code = "Ф Ц"   │               │
│  group = "ATT"   │               │
└──────────────────┘               │
                                   │
         ┌─────────────────────────┘
         │ player_id
         ↓
┌─────────────────────────────┐
│   player_statistics         │  Статистика
│  player_id = 1              │
│  slice_id = 1               │
│  metric_code = 'goals'      │
│  metric_value = 21.0        │
└─────────┬───────────────────┘
          │
          │ slice_id
          ↓
┌─────────────────────────────┐
│      stat_slices            │  "Папки" со статистикой
│  slice_id = 1               │
│  tournament_id = 0          │◄─────┐
│  slice_type = 'TOTAL'       │      │
│  period_type = 'SEASON'     │      │
│  period_value = '2025' │      │
└─────────────────────────────┘      │
                                     │
          ┌──────────────────────────┘
          │ tournament_id
          │ (обратная связь)
```

### Пример полного запроса:

```sql
-- Получить ВСЮ информацию об игроке
SELECT 
    -- Игрок
    p.player_id,
    p.full_name,
    p.birth_year,
    p.team_name,
    
    -- Позиция
    pos.code as position_code,
    pos.group_code as position_group,
    pos.display_name as position_name,
    
    -- Турнир
    t.name as tournament_name,
    t.season as current_season,
    
    -- Слайс
    ss.slice_type,
    ss.period_type,
    ss.period_value,
    
    -- Статистика
    ps.metric_code,
    mc.display_name_ru as metric_name,
    ps.metric_value

FROM player_statistics ps

-- Присоединяем игрока
JOIN players p ON ps.player_id = p.player_id

-- Присоединяем позицию
JOIN positions pos ON p.position_id = pos.position_id

-- Присоединяем турнир
JOIN tournaments t ON p.tournament_id = t.id

-- Присоединяем слайс
JOIN stat_slices ss ON ps.slice_id = ss.slice_id

-- Присоединяем справочник метрик
JOIN metrics_catalog mc ON ps.metric_code = mc.metric_code

WHERE p.full_name = 'Александр Помалюк'
  AND ss.period_value = '2025'
  AND ss.slice_type = 'TOTAL';
```

**Результат:**

| full_name | position | tournament | season | metric | value |
|-----------|----------|------------|--------|--------|-------|
| Помалюк   | Ф Ц     | МФЛ        | 2025 | Голы | 21 |
| Помалюк   | Ф Ц     | МФЛ        | 2025 | xG | 14.27 |
| Помалюк   | Ф Ц     | МФЛ        | 2025 | Удары | 87 |
| ...       | ...      | ...        | ...    | ...  | ... |

---

## 6️⃣ Схема всех процессов

### Полный цикл жизни данных:

```
┌─────────────────────────────────────────────────────────────┐
│                  ЖИЗНЕННЫЙ ЦИКЛ ДАННЫХ                      │
└─────────────────────────────────────────────────────────────┘

1️⃣ ЗАГРУЗКА ФАЙЛА
   
   📂 mfl.xlsx (896 игроков × 52 метрики)
   │
   ↓
   🔍 Система читает Excel
   │
   ↓
   🎯 Определяет: tournament_id, slice_type, season
   │
   ↓
   🔄 Создаёт/находит slice в stat_slices
   │
   ├─ Если slice существует:
   │  └─ DELETE старая статистика
   │     INSERT новая статистика
   │
   └─ Если slice новый:
      └─ INSERT новый slice
         INSERT новая статистика

2️⃣ ХРАНЕНИЕ

   📚 БД:
   ├─ tournaments (4 турнира)
   ├─ positions (23 позиции)
   ├─ metrics_catalog (52 метрики)
   ├─ players (896+ игроков)
   ├─ stat_slices (N слайсов)
   └─ player_statistics (46,592+ записей)

3️⃣ ЗАПРОСЫ

   📊 Фронтенд запрашивает:
   │
   ├─ Все игроки турнира
   │  └─ SELECT ... JOIN ... WHERE tournament_id = 0
   │
   ├─ Топ-10 бомбардиров
   │  └─ SELECT ... ORDER BY metric_value DESC LIMIT 10
   │
   ├─ Фильтр: shots > 50 AND xg > 5
   │  └─ SELECT ... HAVING ...
   │
   └─ Сравнение с средними
      └─ WITH avg AS (...) SELECT ... WHERE value > avg

4️⃣ ОТОБРАЖЕНИЕ

   🖥️ Фронтенд получает данные:
   │
   ├─ Округляет числа (только при показе!)
   │  └─ 1.3 → 1.5
   │  └─ 2.8 → 3.0
   │  └─ xG: 14.27 → 14.27 (исключение!)
   │
   └─ Показывает пользователю

5️⃣ ОБНОВЛЕНИЕ

   🔄 Пользователь загружает новый файл:
   │
   ├─ Тот же сезон?
   │  └─ YES: Обновить существующий slice
   │
   └─ Новый сезон?
      └─ Спросить: "Создать новый?"
         ├─ YES: Создать новый slice
         └─ NO: Обновить текущий
```

---

## 🎉 ИТОГОВАЯ СХЕМА: ВСЁ ВМЕСТЕ

```
┌─────────────────────────────────────────────────────────────────┐
│                     ФУТБОЛЬНАЯ СТАТИСТИКА                       │
└─────────────────────────────────────────────────────────────────┘

📁 СПРАВОЧНИКИ (не меняются)
├─ 🏆 tournaments: МФЛ, ЮФЛ-1, ЮФЛ-2, ЮФЛ-3
├─ ⚽ positions: Ф Ц, АП Л, П Ц, З Ц... (23 позиции)
└─ 📊 metrics_catalog: goals, xg, shots... (52 метрики)

📁 ИГРОКИ
└─ 👤 players: 896 игроков (Помалюк, Иванов, Петров...)
    │
    ├─ Уникальность: (имя + год + команда + турнир)
    └─ Связь с: positions, tournaments

📁 СЛАЙСЫ (папки со статистикой)
└─ 📊 stat_slices:
    │
    ├─ slice_id=1: МФЛ 2025 TOTAL (суммарная за сезон)
    ├─ slice_id=2: МФЛ 2025 PER90 (средняя за 90 минут)
    ├─ slice_id=3: МФЛ 2025 ROUND=31 (31-й тур)
    └─ slice_id=4: МФЛ 2026 TOTAL (новый сезон)

📁 СТАТИСТИКА
└─ 📈 player_statistics: 46,592 записей
    │
    ├─ Помалюк (slice_id=1): goals=23, xg=15.85, shots=87...
    ├─ Помалюк (slice_id=2): goals=0.85, xg=0.64, shots=3.5...
    ├─ Помалюк (slice_id=3): goals=2, xg=1.56, shots=8...
    └─ Помалюк (slice_id=4): goals=5, xg=3.82, shots=23...

┌─────────────────────────────────────────────────────────────────┐
│                        КАК ЭТО РАБОТАЕТ                         │
└─────────────────────────────────────────────────────────────────┘

📥 ЗАГРУЗКА:
   mfl.xlsx → Читается → Создаётся slice → Загружаются игроки → 
   → Загружается статистика → ✅ Готово!

🔄 ОБНОВЛЕНИЕ:
   Тот же сезон → Находится slice → УДАЛЯЕТ старую статистику →
   → Загружает новую → ✅ Обновлено!

🆕 НОВЫЙ СЕЗОН:
   Новый сезон → Спрашивает пользователя → Создаёт новый slice →
   → Загружает статистику → ✅ Новый сезон!

📊 ЗАПРОСЫ:
   Фронтенд → SQL запрос → JOIN таблиц → Фильтры → 
   → Сортировка → Округление → ✅ Показать!

🎯 СРАВНЕНИЕ:
   Средние по позиции → AVG() всех игроков → Сравнить с конкретным →
   → Вычислить разницу → ✅ "Выше/ниже среднего!"
```

---

## ✨ ГЛАВНЫЕ ПРАВИЛА (запомни!)

### 1️⃣ Данные в БД - БЕЗ ИЗМЕНЕНИЙ

```
Excel: 14.27 → БД: 14.27 (ТОЧНО!)
Округление ТОЛЬКО при отображении!
```

### 2️⃣ Один slice = один сезон

```
Загрузка 1-30 туров → slice_id=1
Загрузка 1-31 туров → slice_id=1 (обновлён!)
Загрузка 1-32 туров → slice_id=1 (обновлён!)
```

### 3️⃣ Новый сезон = новый slice

```
Сезон 2025 → slice_id=1
Сезон 2026 → slice_id=2 (новый!)
```

### 4️⃣ TOTAL и PER90 - разные slice

```
TOTAL → slice_id=1 (21 гол всего)
PER90 → slice_id=2 (0.85 голов/матч)
```

### 5️⃣ Игрок = уникальная комбинация

```
Помалюк + 2005 + Спартак + МФЛ = player_id=1
Помалюк + 2005 + ЦСКА + МФЛ = player_id=897 (новый!)
```

---

## 🎓 ФИНАЛЬНЫЙ ТЕСТ: Проверь себя!

### Вопрос 1:
Загрузили `mfl.xlsx` (1-30 туров). Затем загрузили `mfl.xlsx` (1-31 туров).  
**Сколько слайсов в БД?**

<details>
<summary>Ответ</summary>

**1 slice** (обновился тот же slice, т.к. сезон не изменился)
</details>

### Вопрос 2:
Помалюк забил 21 гол. Средний форвард - 15 голов. **Помалюк лучше среднего?**

<details>
<summary>Ответ</summary>

**ДА!** 21 > 15, разница +6 голов ✅
</details>

### Вопрос 3:
Загрузили `mfl.xlsx` (2025), затем `mfl.xlsx` (2026).  
**Что нужно сделать?**

<details>
<summary>Ответ</summary>

**Использовать `force_new_season=True`** чтобы создать новый slice!  
Иначе старые данные удалятся.
</details>

---

## 🎉 ГОТОВО!

**Теперь ты понимаешь:**
- ✅ Как устроена БД
- ✅ Как загружаются файлы
- ✅ Как обновляются данные
- ✅ Как работают сезоны
- ✅ Как сравнивать с средними
- ✅ Как всё связано

**Следующий шаг:** Попробуй сам загрузить файл! 🚀



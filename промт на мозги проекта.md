
Сделай в проекте во вкладке лучшие выступления за тур систему поиска “талантов тура” на основе **перцентилей по позиции**. Данные уже загружаются в БД через текущую систему слайсов (сезонные TOTAL/PER90 и туровые данные). Нужно, чтобы после загрузки статистики **за тур** автоматически считались сравнения и формировалась выдача “топ выступления тура”, а при клике на игрока показывались подробные сравнения.

#### Что должно получиться в итоге (поведение продукта)
- Пользователь загружает файл статистики **за тур**.
- Система:
  - находит всех игроков, сыгравших в этом туре
  - определяет их позицию
  - считает для них **перцентиль по каждой метрике**, но **только по нужным метрикам для их позиции** (список метрик и разделение `core/support/risk` берётся из `POSITION_INFO.txt`)
  - строит рейтинг “лучшие выступления тура” и “топ по позициям”
- При открытии игрока из тура показываются **3 сравнения**:
  1) **Основное:** против игроков **той же позиции** в **текущем турнире текущего сезона** (baseline season-to-date, per90).
  2) **С учётом силы команды:** если команда в верхней/нижней половине таблицы, сравнивать с игроками той же позиции **только из верхней/нижней половины** (на момент этого тура). это для того чтобы находить сильных футболистов в слабых командах.
  3) **Сравнение с прошлыми сезонами именно этого турнира:** против игроков той же позиции в прошлом сезоне этого турнира (baseline per90 прошлого сезона). это должно быть реализовано так: если юзер не загрузил нужный турнир с чем сравнивать то надо загрузить. когда юзер загружает нужный турнир то это должен быть точно такой же файл xlsx который загружают во вкладку все футболиста турнира. и этот сравниваемый турнир сохраняется пока юзер не добавит новый. при добавлении нового сравниваемого турнира старый удаляется.  все также по каждой позиции сравниваемого турнира надо сделать перцентиль по каждой метрике, но только по нужным метрикам для их позиции, как и во всех 3 пунктах.
  - Метрики `risk` **не штрафуют** игрока в итоговом рейтинге — только отображаются как **пометки/флаги**.

#### Правила расчёта (обязательно)
- Перцентиль считается **внутри позиции** и **по каждой метрике отдельно**.
- Перцентиль — это доля игроков в baseline-группе, у которых значение метрики **меньше или равно** значению игрока.
- Никаких округлений при хранении: данные должны оставаться “как в xlsx”. Округление — только на отображении (как уже принято в проекте).
- Если данных мало (слишком маленькая выборка в позиции/половине таблицы) — показывай, что “недостаточно данных” и не пытайся натянуть точный percentile.
- `core` — главный (по нему сортировка/выдача), `support` — доп. профиль, `risk` — только флаги. должна быть сортировка по core, support, core+support, risk показывается везде но должна быть функция отключить отображать risk.

#### Что надо реализовать (план простыми шагами)
1) Научись **читать `POSITION_INFO.txt`** и иметь структуру: для каждой позиции списки `core/support/risk` метрик (metric_code).эти все данные можно перенести в таблицу они не будут изменяться. 
2) Добавь место, где это хранится/кэшируется (в БД или в коде), чтобы система могла быстро получать “метрики позиции”.
3) Добавь хранение и обновление **мест команд по турам именно этого туринра именно этого года(как мы добавляем футболистов в турниры)** (standings), чтобы можно было определить: команда игрока в **верхней** или **нижней** половине на момент тура. то есть программа должна знать футболист играет в команде которая в верхней части таблицы или в нижней. именно какое место команда занмиает не важно, только верхняя часть или нижняя. как должны появляться эти списки. если начинается новый турнир в новом году например был юфл1 2025 года стал 2026, при первой загрузки турнира идет парсинг и образуется таблица с командами которые участвуют ребята. и дальше при выборе сравнения с учетом силы команд(это второй пункт сравнения), то там две ситуации, елси ситсема пишет что не знает какие места занимают команды(имеется ввиду верхняя часть или нижняя), то просит распределить команды и тут юзер просто должен перетащить команды верх или низ. команды запоминаются и начинается сравнение с верзней части или нижней. надо понимать что юзер в любой момент должен обладать возможностью поменять команды корзинами и также может сделать чтобы в одной корзине было больше комнад чем в другой и наоборот. это позоволит гибко настраивать уровень команд. при новом сезоне или очистки БД все должно быть заново.
4) После загрузки тура запускай расчёт:
   - выбирай baseline “текущий сезон per90” этого турнира
   - выбирай baseline “прошлый сезон per90”
   - по standings определяй верх/низ половину и строь baseline “верх/низ per90 текущего сезона”
5) Для каждого игрока тура:
   - собери значения метрик тура по списку метрик его позиции
   - посчитай percentiles для трёх сравнений (основное, верх/низ, прошлый сезон)
   - посчитай агрегаты:
     - `core_score` = средний percentile по core-метрикам
     - `support_score` = средний percentile по support
     - `total_score` = комбинированный (например core важнее support)
   - собери `risk_flags` (красная/жёлтая, грубые/голевые ошибки, фолы и т.д.)
6) Сохрани результаты расчёта так, чтобы их можно было быстро отдавать без пересчёта:
   - per-player per-metric percentiles по каждому из трёх сравнений
   - per-player scores и risk_flags по каждому из трёх сравнений

7) Сделай выдачу:
   - “лучшие выступления тура” (общий топ) по `total_score` или `core_score` (core — приоритет)
   - “топ по позициям” за тур
   и там и там сделай три воронки показа футболистов.большая выборка например 75p+, более узкая 85p+ и самые лучшие футболисты 90p+. как правльно выбрать нужные перцентили для трех воронок реши сам я привел пример. на странице тоже дожна быть показано топ по каждому трем сравнения, юзер может выбрать отображение каждой их воронки(средняя воронка по умолчанию). и также везде должно быть отображение core, core+support, support. также само собо пользователь может посмотреть историю предыдущих туров как всего турнира так и на странице карточки любого футболиста(индивидульно что например псомотреть по турам только как иванов по перцентилю выглядил каждый тур)
8) Сделай карточку игрока тура:
   - показывает 3 сравнения
   - в каждом сравнении: core/support/risk метрики, значение за тур и percentile
   - отдельно показывай итоговые score и risk_flags
   плюсом при нажатии на любого футболсита я должен видеть его сравнения даже если он не в топе. 

#### Критично (что нельзя сломать)
- Не менять существующую логику импорта и хранение сырых значений.
- Соблюдать соответствие турниров файлам (0 mfl, 1 yfl1, 2 yfl2, 3 yfl3).
- `xg`/`xa` хранить как дробные значения “как в файле”.

Сделай реализацию максимально надёжной и быстрой: расчёты по возможности батчами и SQL-окнами/агрегациями, без циклов “по игроку × по метрике” в питоне.

# 🔄 Логика UPSERT: Сохранение истории игроков

## ✅ Что изменилось

**Было (DELETE + INSERT):**
```
Загрузка файла → УДАЛИТЬ все данные slice → Вставить новые
```

**Стало (UPSERT):**
```
Загрузка файла → Обновить существующие + Добавить новые
```

---

## 🎯 Преимущества UPSERT

### 1. Игрок в разных командах = разные записи

```
📅 Тур 15: Помалюк в Спартаке
📅 Тур 20: Помалюк перешёл в ЦСКА

📊 В БД теперь ДВА Помалюка:

┌───────────┬──────────────────┬──────────┬───────┐
│ player_id │ full_name        │ team     │ goals │
├───────────┼──────────────────┼──────────┼───────┤
│ 1         │ Помалюк Александр│ Спартак  │ 10    │  ⬅️ За Спартак
│ 2         │ Помалюк Александр│ ЦСКА     │ 5     │  ⬅️ За ЦСКА
└───────────┴──────────────────┴──────────┴───────┘

✅ Можно сравнить статистику за разные команды!
```

### 2. История сохраняется

```
Если игрок ушёл из турнира:
- При DELETE + INSERT: его данные удалялись ❌
- При UPSERT: его данные СОХРАНЯЮТСЯ ✅

Это полезно для анализа:
- "Какие игроки ушли?"
- "Какая была их статистика?"
```

---

## 📊 Как это работает

### Сценарий: Помалюк перешёл из Спартака в ЦСКА

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        АЛГОРИТМ UPSERT                                      │
└─────────────────────────────────────────────────────────────────────────────┘

📅 ТУР 15 (первая загрузка):

Excel файл:
┌──────────────────┬──────────┬───────┐
│ Игрок            │ Команда  │ Голы  │
├──────────────────┼──────────┼───────┤
│ Помалюк Александр│ Спартак  │ 10    │
│ Иванов Пётр      │ ЦСКА     │ 8     │
└──────────────────┴──────────┴───────┘

                    │
                    ▼

Таблица players:
┌───────────┬──────────────────┬──────────┐
│ player_id │ full_name        │ team     │
├───────────┼──────────────────┼──────────┤
│ 1         │ Помалюк Александр│ Спартак  │  ⬅️ СОЗДАН
│ 2         │ Иванов Пётр      │ ЦСКА     │  ⬅️ СОЗДАН
└───────────┴──────────────────┴──────────┘

Таблица player_statistics:
┌───────────┬──────────┬─────────────┬──────────────┐
│ player_id │ slice_id │ metric_code │ metric_value │
├───────────┼──────────┼─────────────┼──────────────┤
│ 1         │ 1        │ goals       │ 10           │  ⬅️ СОЗДАН
│ 2         │ 1        │ goals       │ 8            │  ⬅️ СОЗДАН
└───────────┴──────────┴─────────────┴──────────────┘

═══════════════════════════════════════════════════════════════════════════════

📅 ТУР 20 (Помалюк перешёл в ЦСКА):

Excel файл:
┌──────────────────┬──────────┬───────┐
│ Игрок            │ Команда  │ Голы  │
├──────────────────┼──────────┼───────┤
│ Помалюк Александр│ ЦСКА     │ 5     │  ⬅️ Новая команда!
│ Иванов Пётр      │ ЦСКА     │ 12    │
└──────────────────┴──────────┴───────┘

                    │
                    ▼

🔍 Система ищет: (Помалюк, ЦСКА, МФЛ) → НЕ НАЙДЕН!
🔍 Система ищет: (Иванов, ЦСКА, МФЛ) → НАЙДЕН (player_id=2)

                    │
                    ▼

Таблица players:
┌───────────┬──────────────────┬──────────┐
│ player_id │ full_name        │ team     │
├───────────┼──────────────────┼──────────┤
│ 1         │ Помалюк Александр│ Спартак  │  ⬅️ СОХРАНЁН (история!)
│ 2         │ Иванов Пётр      │ ЦСКА     │  ⬅️ Без изменений
│ 3         │ Помалюк Александр│ ЦСКА     │  ⬅️ СОЗДАН (новая команда!)
└───────────┴──────────────────┴──────────┘

Таблица player_statistics:
┌───────────┬──────────┬─────────────┬──────────────┐
│ player_id │ slice_id │ metric_code │ metric_value │
├───────────┼──────────┼─────────────┼──────────────┤
│ 1         │ 1        │ goals       │ 10           │  ⬅️ СОХРАНЁН (история!)
│ 2         │ 1        │ goals       │ 12           │  ⬅️ ОБНОВЛЁН (8→12)
│ 3         │ 1        │ goals       │ 5            │  ⬅️ СОЗДАН
└───────────┴──────────┴─────────────┴──────────────┘
```

---

## 🔑 Ключевые моменты

### 1. Уникальность игрока

```sql
-- Игрок = уникальная комбинация:
UNIQUE (full_name, birth_year, team_name, tournament_id)

-- Помалюк в Спартаке ≠ Помалюк в ЦСКА!
```

### 2. UPSERT для статистики

```sql
INSERT INTO player_statistics (player_id, slice_id, metric_code, metric_value)
VALUES (:player_id, :slice_id, :metric_code, :metric_value)
ON CONFLICT (player_id, slice_id, metric_code)
DO UPDATE SET
    metric_value = EXCLUDED.metric_value,
    updated_at = CURRENT_TIMESTAMP
```

### 3. Что происходит при загрузке

| Ситуация | Действие |
|----------|----------|
| Игрок есть в БД, та же команда | UPSERT статистики (обновляем) |
| Игрок есть в БД, другая команда | Создаём НОВОГО игрока + статистику |
| Игрока нет в БД | Создаём игрока + статистику |
| Игрок был в БД, но нет в файле | СОХРАНЯЕТСЯ (история!) |

---

## 📊 Сравнение статистики игрока

### SQL запрос: Помалюк в разных командах

```sql
SELECT 
    p.team_name,
    ps.metric_value as goals
FROM player_statistics ps
JOIN players p ON ps.player_id = p.player_id
WHERE 
    p.full_name = 'Помалюк Александр'
    AND ps.metric_code = 'goals'
ORDER BY p.team_name;

-- Результат:
-- team_name │ goals
-- ──────────┼───────
-- Спартак   │ 10     ⬅️ За Спартак
-- ЦСКА      │ 5      ⬅️ За ЦСКА
```

### Визуализация:

```
🏆 ПОМАЛЮК АЛЕКСАНДР - Статистика по командам

┌─────────────┬───────┬───────┬────────┬─────────┐
│ Команда     │ Голы  │ xG    │ Удары  │ Передачи│
├─────────────┼───────┼───────┼────────┼─────────┤
│ Спартак     │ 10    │ 8.5   │ 45     │ 3       │
│ ЦСКА        │ 5     │ 4.2   │ 22     │ 2       │
├─────────────┼───────┼───────┼────────┼─────────┤
│ ИТОГО       │ 15    │ 12.7  │ 67     │ 5       │
└─────────────┴───────┴───────┴────────┴─────────┘

📈 Вывод: В Спартаке забивал больше!
```

---

## ⚠️ Важные замечания

### 1. Метрики с пустыми значениями

Если в файле метрика пустая (NULL), старое значение **СОХРАНЯЕТСЯ**:

```
Тур 15: xG = 5.5
Тур 20: xG = пусто (нет данных)

В БД: xG = 5.5 (старое значение)
```

**Это нормально!** Пустая ячейка ≠ ноль. Старые данные актуальны.

### 2. Игроки которые ушли

Если игрок ушёл из турнира, его данные **НЕ удаляются**:

```
Тур 15: Петров в файле
Тур 20: Петрова НЕТ в файле

В БД: Петров СОХРАНЁН (для истории)
```

### 3. Как найти "ушедших" игроков?

```sql
-- Игроки которых нет в последней загрузке
SELECT p.full_name, p.team_name, ps.updated_at
FROM players p
JOIN player_statistics ps ON p.player_id = ps.player_id
WHERE 
    p.tournament_id = 0
    AND ps.updated_at < (
        SELECT MAX(uploaded_at) FROM stat_slices 
        WHERE tournament_id = 0 AND period_type = 'SEASON'
    )
GROUP BY p.player_id;
```

---

## 🎯 Итого

### Новая логика:

```
┌─────────────────────────────────────────────────────────────┐
│                      UPSERT ЛОГИКА                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📂 Загрузка файла                                          │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────────────────────────────┐                    │
│  │ Для каждого игрока в файле:        │                    │
│  │                                     │                    │
│  │ 1. Найти/создать player_id         │                    │
│  │    (по имени + команда + турнир)   │                    │
│  │                                     │                    │
│  │ 2. UPSERT статистики               │                    │
│  │    - Есть → обновить               │                    │
│  │    - Нет → создать                 │                    │
│  └─────────────────────────────────────┘                    │
│       │                                                     │
│       ▼                                                     │
│  ✅ Готово!                                                 │
│                                                             │
│  • Новые игроки добавлены                                   │
│  • Существующие обновлены                                   │
│  • Ушедшие СОХРАНЕНЫ (история!)                             │
│  • Игрок в разных командах = разные записи                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Преимущества:

1. ✅ **История игроков сохраняется**
2. ✅ **Игрок в разных командах = разные записи**
3. ✅ **Можно сравнивать статистику за разные команды**
4. ✅ **Быстрее** (не удаляем 46K записей)
5. ✅ **Данные ушедших игроков для анализа**

---

**Готово! 🎉**



